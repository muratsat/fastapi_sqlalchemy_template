# Alembic Setup Guide

Step-by-step instructions to set up Alembic for database migrations in this project.

## Prerequisites

Ensure `asyncpg` is installed (required for async PostgreSQL):

```bash
pip install asyncpg==0.30.0
```

Update `requirements.txt` to include it.

## Step 1: Initialize Alembic

Run the following command from your project root:

```bash
alembic init alembic
```

This creates:

- `alembic/` directory with migration scripts
- `alembic.ini` configuration file

## Step 2: Configure alembic.ini

Edit `alembic.ini` and update the database URL line:

```ini
# Replace this line:
sqlalchemy.url = driver://user:pass@localhost/dbname

# With this (comment it out since we'll use env.py instead):
# sqlalchemy.url =
```

## Step 3: Configure alembic/env.py

Replace the contents of `alembic/env.py` with:

```python
from logging.config import fileConfig

from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config

from alembic import context

# Import your models and config
from app.config import env as app_env
from app.db import Base
import app.db.models  # This imports all models from the models module

# this is the Alembic Config object
config = context.config

# Set the database URL from your config
config.set_main_option("sqlalchemy.url", app_env.DATABASE_URL)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

# Set target metadata for autogenerate support
target_metadata = Base.metadata


def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()


def do_run_migrations(connection: Connection) -> None:
    context.configure(connection=connection, target_metadata=target_metadata)

    with context.begin_transaction():
        context.run_migrations()


async def run_async_migrations() -> None:
    """Run migrations in 'online' mode with async support."""
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()


def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    import asyncio
    asyncio.run(run_async_migrations())


if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()
```

## Step 4: Create Your First Migration

Generate an initial migration based on your models:

```bash
alembic revision --autogenerate -m "Initial migration with users table"
```

This creates a new migration file in `alembic/versions/`.

## Step 5: Review the Migration

Open the generated migration file in `alembic/versions/` and verify it looks correct.

## Step 6: Apply the Migration

Run the migration to create tables in your database:

```bash
alembic upgrade head
```

## Common Commands

### Create a new migration (after model changes)

```bash
alembic revision --autogenerate -m "Description of changes"
```

### Apply all pending migrations

```bash
alembic upgrade head
```

### Rollback one migration

```bash
alembic downgrade -1
```

### View migration history

```bash
alembic history
```

### View current revision

```bash
alembic current
```

### Rollback to specific revision

```bash
alembic downgrade <revision_id>
```

## Important Notes

1. Always review autogenerated migrations before applying them
2. Alembic may not detect all changes (like column type changes in some cases)
3. Keep your migrations in version control
4. Never edit applied migrations - create new ones instead
5. Make sure to import ALL your models in `alembic/env.py` for autogenerate to work

## Troubleshooting

### "Target database is not up to date"

Run `alembic upgrade head` to apply pending migrations.

### "Can't locate revision identified by 'xxxxx'"

Your database and migration files are out of sync. Check `alembic_version` table in your database.

### Autogenerate doesn't detect changes

Make sure all models are imported in `alembic/env.py` and inherit from `Base`.
